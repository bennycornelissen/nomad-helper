sudo: required

language: go

go:
  - 1.10.1

services:
  - docker

cache:
  directories:
    - vendor/

env:
  global:
    - CGO_ENABLED=0
    - GOBUILD="linux-amd64 windows-amd64 darwin-amd64"

script:
  - make -j dist
  - ls -la build

after_success:
  - export PR=https://api.github.com/repos/$TRAVIS_REPO_SLUG/pulls/$TRAVIS_PULL_REQUEST
  - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo `curl -s $PR | jq -r .head.ref`; fi)
  - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
  - if [[ "$TRAVIS_PULL_REQUEST" != "false" ]]; then make -j docker TAG=pr-$TRAVIS_PULL_REQUEST COMMIT=$TRAVIS_COMMIT; fi
  - if [[ "$TRAVIS_TAG" =~ ^v.*$ ]]; then make -j docker TAG=$TRAVIS_TAG COMMIT=$TRAVIS_COMMIT; fi
  - if [[ "$BRANCH" == "master" ]]; then make -j docker TAG=latest COMMIT=$TRAVIS_COMMIT; fi

deploy:
  provider: releases
  api_key:
    secure: "An5zZP1b6D10TrQAKSq1wN97S0bLlUDPJ8sEUEk0UB1IQJVhY7wdOT+26eFZdb3Li3Ikgr7l3lhl4GTxjMCmVPwtl39TbKQoOQc7Qz6NEOLOsU8Q7CISEJ+y181HQsUCUn+8YbGh9k+V82IoLIP7D8LCWvtYawB+r+jHiyOBCDmqMEBZ4v1VKUdKm9WcosSYspxjuX3X9j9w3592zLmM7EZpjzBN6yQFXpwaH3BM0jP2lVNr6rMZ8EYZOO3ipngqO5Eixg/4Nd1BZTIAR2+K7gjbDsuzB20PiFBLqFkAXRf5rQpqPAjApTf4KTjCy6tEv7MvWTbr6t7bgDGzDKeGO4goq0Gr4l1fydYOB1qpx/5Az1IqXqaEdHyqWoQ5dTEBUsBuC8ryDXKXqlSeuLR4/7Gy4g1Qd5rNzXM4twLT+BdBO8h3Ev2heQmZPmE/NjLdtc1l2te4UlU1M1bb9Mi6GQv3+s9AatoeftcE6OQLdKIppD8nOPzRNsaO9bTJ6VPvDginlKLuB7fXC1pFuzIZBH3qf9LQBGkV2Z6PgmosOb++6qc19zrlhXzyMC2gzVRSr26uiBjVbSWfcxbx2sr3ydzgrzwYv/j0PLJt+3Qvav7UmK1gYpv+Vyt20NSgoDrZU/3li7m+GSqDDx4HeO0IgEc3Le97WI2VBNhsUtsDTJY="
  file:
    - build/nomad-helper-linux-amd64
    - build/nomad-helper-windows-amd64
    - build/nomad-helper-darwin-amd64
  skip_cleanup: true
  overwrite: true
  on:
    tags: true
    repo: seatgeek/nomad-helper
