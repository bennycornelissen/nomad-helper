sudo: required

language: go

go:
  - 1.10.1

services:
  - docker

cache:
  directories:
    - vendor/

env:
  global:
    - CGO_ENABLED=0
    - GOBUILD="linux-amd64 windows-amd64 darwin-amd64"
    - secure: "qm4a45lPwPfJLuEdN6lS0tI0sjppZW7xYEufm4ECG5ImjduXR9aELe9tzVnzx8EdTVnazDO+uyv6ch4wAyw4iFecaG4zYJ5FwMs7KvBKnj2q9vjgDPD8GRXz6+6oUskCMnP0fPxLlHDCNr43qyA/nYQwfbRPR15N5U9qr/xf24DRNwffj1bcGNRQPrPdySlPvoA8YxDWp2S32JXPEHwy9XjYh7yznxANhvrciDCSw8LEOeYJiU1AnHI0/hVNeSi0/DuqvCUHk/W3cDp/amB1T/tnehiuQVOry12RpDHdApuT8olEIU0oNP2apDFStoaDaVtpkQ8R4skCUsszegxNauVvcVleH0shBT/JBALGmIPDGfMxhWUssG6NvGqXYLuM8+IXTXj4ozNG5LNWbbAG4bkPR3riUlTFRfuuoqmhxeZu0CvfPMRS2ExNCkUQSOZR2PuuueQR3Fn+7k3qT889cnPbrXFyBTh9blup/R0qIBHpTq2ECbwjrL67SjmULVhM2t5EQftJoBrrtYpaaV8lUQy5pBXiO4G8WQBHRiJUdC284oHZd7c3v97Iy/PV2dR7OiofUhrrLYPaWZ1uoDSusGlzLVhRxT0LZzKS/K6sM5T7+0NUSKXqRD++dZSCxK5y5y7P5nJqqYbC0gwVx7Bl0nL1oBsjXlKey/dulUxlaCY="
    - secure: "MBeTckBWVoKW/3/uWS+f7q4xnmUvRXs6AcoNo7jKlqppKCV8LetnZBfevnpaThQqdlc6nMb1tg5SZz10LOeTSSrADz6FlkJcBh/CBXd5ZpiBX9oXxGqtOO9UsINS4N32Dkff9Dyybx+Nk6MOyRpXuZHPbcWZiAE+xrVXHyqLU5dPGYFvW+PjGKDyL/MDv6MegiEYLzYN8NiwpwjgmU/hgXUrsDqWQ4+3eX/ZgS/kvDq/bOgbP4LMLOyANX3lzy/7GhJB9yKLSgm7Cxkg1DP7bH4UaZlKvdvJYezkxTRr869947Ae1I31aYEEEm2AXFD9FZJvv3LApcnIftKOXqZo5tJBu9OVEr0TZ/S5ybzQuhs8TynrM/Fs9NVO4dZyHXQBvdhqzoUtEB0vGKkmyfc8/3/EHrKfliFv6o/yJRn7b3OYqhwtMeKWV2k3m+L85R6Q2zxpEMteCm+LeKk+gIypXHInAz6ypAq4iEKsIXckKbIdbyFK0Qdd+ecnpzis8M9Qb440yI7AJQKBnreThpZRzTqy7+kFgcGXY8nHJne1O1qKUGcFiUMSeeaZ3MQfSTrmSGUzRd7jveTqCoQrwTvPqcmFfZGDruZKixYhRWc1FLItXmCgpUzEZC22UWFMHuZKy0JFrkelRfYg4ja/mzseAwjd4UkR6Rx8SBVutkdO5SU="

script:
  - GOBUILD=${GOBUILD} make -j dist
  - ls -la build

after_success:
  - export PR=https://api.github.com/repos/$TRAVIS_REPO_SLUG/pulls/$TRAVIS_PULL_REQUEST
  - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo `curl -s $PR | jq -r .head.ref`; fi)
  - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
  - if [[ "$TRAVIS_PULL_REQUEST" != "false" ]]; then make -j docker TAG=pr-$TRAVIS_PULL_REQUEST COMMIT=$TRAVIS_COMMIT; fi
  - if [[ "$TRAVIS_TAG" =~ ^v.*$ ]]; then make -j docker TAG=$TRAVIS_TAG COMMIT=$TRAVIS_COMMIT; fi
  - if [[ "$BRANCH" == "master" ]]; then make -j docker TAG=latest COMMIT=$TRAVIS_COMMIT; fi

deploy:
  provider: releases
  api_key:
    secure: Fe1dfXpqxXaiW6hd596Q/l4ZjyGLqwUllCWSB0Zj95CiokxJiwuTZdMubyxDcR3f1grFJvr4oYjk9klr43jJleSj2QcBrSxBIo0ODg1vWOTlfnPvG6QVrDaDmyNE85iLObvXSErqOQsd+4MEuo5lAvByJveDCJ1bLgtFl+cM1yuz6BIOKh6nZ61NqySUJxJbRobLHyXfEiWbWw0IONTPczt1M6Dg0JRguEKbdlPEathf4k1MuwU42xi3AC58Z3UKitzWCZHIIUaDpbYzS+mrJrINdQtFMSxhitAlvCIOd+p1Sr70yD1c4CGsffkN++m8vmOtuLC/ewkc8HNyDRJ6NOFaVSglBH3hO0dgsI3rSh980m/a5zPIvCARZgZz01aeBoJM7mm6iNB48zZXf4fM5jiFJwlNhIN67LW9Q9OKehiKNMX7i6SQ97GyjXpNMGZ8Vk3qdXDHxRiIW8KlEY3UaNLlzNR2ulO4hVMOhdwbuqo0YCMmxWbtr/Hb9n8urGdgQ75roGM1DrxNVws8oEk+GyGr5fdPq0wCL2U/DWMl23HN9MjQXahzyrn401zJ0EywnvPnDh2OfRXShPWreOFCMeyBMcxo0tWCHHsL0QeXYK1M6JHfcU4V7BdR3oAYLwSH1Vj8rX0i4bjwR+zWJZ5TD/jtIYJFJngo5zKD+DV6AxM=
  file:
    - build/nomad-helper-linux-amd64
    - build/nomad-helper-windows-amd64
    - build/nomad-helper-darwin-amd64
  skip_cleanup: true
  overwrite: true
  on:
    tags: true
    repo: seatgeek/nomad-helper
